# OWASP Top10 2020

> ## @Date：2021-5-8
>
> ## @Author：Tanyiqu

OWASP(Open Web Application Security Project)

- 1.注入
- 2.失效身份验证和会话管理
- 3.敏感信息泄露
- 4.XML外部实体注入攻击（XXE）
- 5.失效访问控制
- 6.安全性错误配置
- 7.Cross-Site-Scripting（XSS）
- 8.不安全的反序列化
- 9.使用具有已知漏洞的组件
- 10.日志记录和监控不足



## 1.注入

### 描述

当用户发送不可信地数据到解释器的时候，就可能出现注入漏洞，比如SQL, NoSQL, LDAP注入，解释器可能会将用户发送的恶意数据视为指令或数据库查询，使得用户在没有权限的情况下访问数据，甚至导致用户完全控制服务器。

### 原因

- 没有验证用户输入
- 没有使用转义
- 恶意指令被拼接

### 避免

- 使用安全的API、参数化的接口或ORM的工具
- 过滤、转义特殊字符
- 使用limit语句，避免数据库泄露大量数据

### 示例

```
在进行登录的时候，后端直接使用用户输入内容拼接SQL语句

代码字符串：select * from user where id='${用户输入的id}' and password = '${用户输入的密码}'

当用户输入：
id：1
password：' or 1=1 #

SQL就会变成 select * from user where id='1' and password = '' or 1=1 #'

就会直接登录成功，拿到id为1的数据
```

<br>

## 2.失效身份验证和会话管理

### 描述

**身份验证**：登录系统验证，常见为账号密码、验证码、客户端证书、Ukey等

**会话管理**：HTTP本身是无状态的，利用会话机制实现连接识别。身份验证通常会会的一个令牌，放在cookie中，之后携带这个令牌的就可以直接识别，不用每次都验证登录

**失效的身份认证和会话管理**：

攻击者破坏密码、密钥、会话令牌或攻击其他的漏洞去冒充其他用户的身份

### 原因

开发人员只关注web应用的功能，往往建立自定义的认证和会话方案，没有对功能做到正确的实现。

### 避免

- 实现多因子认证以组织自动化攻击和凭据重用
- 避免使用默认密码
- 进行弱密码检查
- 对齐密码长度，复杂度
- 确保注册，凭据恢复和API被加固以抵御账户枚举攻击
- 限制或延迟失败的登录尝试，并记录所有失败尝试并在发动攻击时报警
- 使用服务端，安全，内置的会

### 示例

用户登录后没有退出，而是关掉了浏览器，只要使用相同的浏览器，且会话没有及时销毁，就能访问。

<br>

## 3.敏感信息泄露

### 描述

web应用和API没有很好地保护隐私数据，比如金融，医疗。攻击者可以偷取或修改这些数据，从而进行信用卡诈骗，身份窃取等。敏感数据在传输过程中应当使用额外的安全措施以避免泄露。

### 原因

- 数据明文传输
- 数据明文存储
- 使用弱密码算法
- 使用默认密钥，弱密钥，重用密钥
- 没有强制使用安全措施
- 用户终端没有验证接收到的服务器凭据是否有效
- ...

### 避免

- 分类数据，确认哪些数据是敏感的
- 按照分类控制数据
- 尽量不存储敏感数据
- 确保加密所有存储的敏感数据
- 确保使用强的加密算法，使用合适的密钥管理
- 确保传输的敏感信息加密
- 包含敏感数据的响应不缓存
- 使用强的，加盐的hash函数存储密码
- 独立验证配置的有效性

### 示例

攻击者拦截http的请求，获取请求中的cookie等信息，或者修改传输包中的数据。

<br>

## 4.XML外部实体注入攻击（XXE）

### 描述

老版本或弱配置的XML解析器在处理XML文件内的外部实体时，会去运行其中的代码。

### 原因

应用接受XML或XML上传，或向XML中插入了不可信数据。

### 避免

- 使用json等简单的数据格式
- 及时打补丁、升级XML解析器以及使用的库
- 在解析器中禁用XML外部实体和DTD
- ...

### 示例

```xml
<?xml version="1.0" encoding="ISO-8859-1"?> 
<!DOCTYPE foo [ 
<!ELEMENT foo ANY > 
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]> 
<foo>&xxe;</foo> 
```

<br>

## 5.失效访问控制

### 描述

对通过身份验证的用户访问控制权限控制不当。攻击者可以利用这些缺陷访问未经授权的功能或数据。

**表现形式**：

水平权限安全攻击
垂直权限提升攻击

### 原因

- 通过修改URL，内部应用状态，HTML页面绕过访问控制检查
- 允许查看和编辑其他用户的账号
- 提权。
- 元数据操纵，比如重放或伪造JWT token, cookie或隐藏的用于提权的域，或破坏JWT无效机制
- CORS(Cross-Origin Resource Sharing)错误配置允许未授权的API访问
- 强制浏览未授权的页面，API没有进行访问控制

### 避免

- 除了公共资源外，默认禁止访问
- 实现访问控制机制并在系统内到处重用，最小化CORS使用
- 模型访问控制应该强制记录拥有权，而不是用户都能增删改查每一条记录
- 禁止列出WEB服务器目录，确保元数据和备份文件不在根目录
- 记录访问控制失效，合适时警告管理员
- 限制访问API的频率，最小化自动攻击工具的损害
- JWT token应该在登出后立刻失效

### 示例

攻击者登录后，在浏览器地址栏里面输入admin的链接，或者修改?id=xx访问其他用户

<br>

## 6.安全性错误配置

### 描述

安全性错误配置是一种非常常见的问题，网站管理员往往会保留默认配置，这导致了很多安全性问题。系统，应用，框架，库不止应该被安全地配置，他们还应该被及时更新。

错误的安全配置可能会发生在应用栈的任何一个层级上，包括平台，Web服务器，应用服务器，数据库，框架，以及自定义代码。开发者以及系统管理员需要协作以确保整个栈被正确的配置。自动扫描器对检测未打补丁，错误配置，使用默认用户，不必要的服务等等很有帮助。

### 原因

- 在应用栈中任意一处没有安全加固，云服务器授权没有正确配置
- 非必要的特性被启用或安装
- 默认账户和密码没有改变
- 错误处理泄露出了栈追踪，或其他包含信息过多的错误消息被泄露给了用户
- 可升级的系统中最新的安全特性没有被启用或正确配置
- 应用服务器，应用框架，库，数据库中的安全设置没有被设为安全值。
- 服务器没有发送安全头或指令，或是他们呢没有被正确设置
- 软件过时了，易受攻击

### 避免

- 可重复的加固程序，能够更快，更容易地部署环境。确保开发，QA,生产环境配置完全相同，但使用不同的凭据。这个程序应该自动化，以最小化安装安全环境地代价。
- 最小的平台，不包含任何非必须地特性，组件，文档。
- 包管理工具中检查并更新安全配置
- 分段应用结构，使用分段，容器化，云安全组等手段分开组件和用户。
- 发送安全指令到客户端
- 使用自动化进程以验证所有环境中配置的有效性

### 示例

应用服务器中带有案例应用。这些应用中带有攻击者已知的安全漏洞，如果其中一个是admin命令行，默认账号没有修改，攻击者就可以控制服务器。

<br>

## 7.Cross-Site-Scripting（XSS）

### 描述

攻击者向Web页面里插入恶意Script代码，当用户浏览该页之时，嵌入其中Web里面的Script代码会被执行，从而达到恶意攻击用户的目的。

### 原因

- 反射型XSS：应用或API包括未验证的或非转义的用户输入作为HTML的输出的一部分。成功的攻击能够使得攻击者在受害者的浏览器上执行任意HTML和JavaScript。
- 存储型XSS：应用或API存储未格式化的用户输入，且该输入之后会被其他用户或管理员浏览到。
- DOM XSS：动态包含攻击者可控制数据到页面中的JavaScript框架， 单页应用，API易受DOM XSS。

### 避免

- 使用自动转义XSS的框架，比如React JS。学习每种框架的XSS保护，并手动处理用例没有覆盖到的部分。
- 转义不可信的HTTP请求数据能够解决反射型和存储型XSS威胁。
- 在客户端修改浏览器文档时应用内容敏感的编码以抵御DOM XSS。或使用相似的内容敏感转义技术。

### 示例

[xss靶场](https://github.com/do0dl3/xss-labs)

<br>

## 8.不安全的反序列化

### 描述

**序列化**：有些时候我们需要把应用程序中的数据以另一种形式进行表达，以便于将数据存储起来，并在未来某个时间点再次使用，或者便于通过网络传输给接收方。这一过程我们把它叫做序列化。

不安全的反序列化经常会导致远程代码执行。也能用于进行重放攻击，注入攻击，提权攻击。

### 原因

- 对象和数据结构相关攻击：当存在类能够在反序列化过程中或是之后改变应用表现，攻击者就能通过这个类修改应用逻辑，或实现任意远程代码执行
- 典型数据篡改攻击：如访问控制相关攻击，当数据结构存在而内容又能被修改

### 避免

- 对任何序列化对象进行完整性检测，比如数字签名以防止数据篡改或恶意对象
- 在反序列化过程中强制严格的类型限制
- 在低权限环境中独立运行反序列化代码
- 记录反序列化异常和错误，比如收到的类型并不是期望的类型
- 限制或监管入的和出的来自反序列化的容器或服务器的网络链接
- 监管反序列化，当用户一直反序列化时报警

### 示例

```
一段cookie
a:4:{i:0;i:132;i:1;s:7:"Mallory";i:2;s:4:"user";
i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";} 

攻击者可以修改为以下形式
a:4:{i:0;i:1;i:1;s:5:"Alice";i:2;s:5:"admin";
i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}

如果Alice是管理员，且密码为攻击者命中，攻击者就会得到管理员权限
```

<br>

## 9.使用具有已知漏洞的组件

### 描述

库，框架等软件组件和应用有着相同的权限。如果存在有漏洞的组件，那么攻击就能够导致数据泄露甚至控制服务器。组件中的漏洞会导致整个应用和API安全性的下降。

### 原因

- 管理员不知道使用的所有组件的版本，包括直接使用的和嵌套的
- 软件易受攻击，不再支持，或是过时了。包括OS, web服务器，DBMS，APIs和所有组件，运行时环境，库。
- 没有周期性扫描漏洞，没有关注所使用组件的安全公告。
- 没有及时修复或升级平台，框架，依赖。
- 软件开发者没有测试升级，更新，补丁的兼容性

### 避免

- 移除不再使用的依赖，不必须的特性，组件，文件，文档
- 持续地列出目前之用的组件和依赖地版本，使用诸如DependencyCheck 之类的工具。持续关注CVE, NVD上的关于对应组件的漏洞。使用SCA(software composition analysis)自动化这个过程，订阅关于所使用组件的邮件通知
- 只从官方来源得到组件，签名的包更好
- 关注不再维护的库和组件，如果打补丁不再可能，考虑部署虚拟补丁

### 示例

大部分IoT设备很难被打补丁

<br>

## 10.日志记录和监控不足

### 描述

日志和监控不足，再加上缺失或无效的事件响应，允许攻击者进一步攻击系统，他可以转向更多系统，进行篡改，提取，销毁数据。

### 原因

- 可审计的事件，比如登录，登录失败没有被记录。
- 警告和错误没有产生足够的，清晰的日志消息
- 应用和API关于可疑活动的日志没有被监管。
- 日志只本地存储
- 没有设置合适的警告阈值和响应升级流程
- 渗透测试和扫描工具没有触发警告。
- 应用无法实时检测，或对攻击做出警告

### 避免

- 确保登录，访问控制失败，服务断输入验证失败等事件会被日志记录，同时记录足够多的用户上下文以确定可疑账号。保存足够长的时间以用于分析。
- 确保日志以一定格式生成，便于日志管理。
- 确保高额转账带有审计跟踪和完整性控制以避免篡改或删除
- 建立有效的监管和报警机制，使得可疑活动被及时检测和响应。
- 建立事件响应和恢复计划。

### 示例

攻击者用常用密码撞库，每个账户只登录失败一次，如果没有合适的报警机制就会忽视。
恶意软件检测沙盒报警了很多次确没有引起重视，最后因为盗刷银行卡被察觉。

<br>

参考：https://blog.csdn.net/yxiangfei/article/details/109234147